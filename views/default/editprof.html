{{extend 'layout.html'}}
<head>
    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-latest.js"></script>
</head>

<div id="notloggedin" class="hidethis">
    <span id="notloggedin">You haven't logged in yet! Please login or Sign Up!</span>
</div>

<div id="logout" class="btn-group hidethis">
    <a id="saveprof" class="btn btn-success">Save Profile</a>
    <a id="cancel" class="btn btn-danger">cancel</a>
    <a id="logoutbtn" class="btn btn-primary">Log Out</a>
</div>




<div id="userInfo" class="hidethis">
    <div id="home">
        <div id="profile" class="hidethis">
            <img src="" id="editprofilepic">
            <input type="file" id="fileBrowser" style="visibility:hidden; display:none;" />
        </div>

        <table>
            <tr>
                <td>
                    <p id="biolabel">My Bio</p>
                </td>
            </tr>
            <tr>
                <td>
                    <textarea id="inputbio" class="form-control no-menu" style="display: none;" spellcheck="true"></textarea>
                    <p id="editbio"></p>
                </td>
            </tr>
            <tr>
                <td>
                    <p id="courselabel"></p>
                </td>
            </tr>
            <tr>
                <td>
                    <a id="delete" class="btn btn-danger" style="display: none;">Delete</a>
                    <a id="add" class="btn btn-success" style="display: none;">Add</a>
                    <textarea class="form-control no-menu" id="inputcourses" style="display: none;" placeholder="Add a Course i.e. CMPS115 CMPS101"></textarea>
                    <textarea class="form-control no-menu" id="deletecourses" style="display: none;" placeholder="Enter the classes you want to delete in a space separated list"></textarea>
                    <table id="coursetable">
                    </table>
                </td>
            </tr>
        </table>
    </div>
</div>


<script type="text/javascript">
    Parse.initialize("sm3IJPOksqi4vIIN99wmppWnGWFZ0lvsVLNQ9VuO", "MaOO36yKaoEH6bdOlVCnNsaBYAhMfxnGS8MhYrTv");
    var currUser = Parse.User.current();

    function isHidden(el) {
        var style = window.getComputedStyle(el);
        return (style.display === 'none')
    }

    if(currUser == null){
        $("#notloggedin").addClass("hidethis");
        $("#profile").removeClass("hidethis");
        $("#userInfo").addClass("hidethis");
        $("#logout").addClass("hidethis");
        setTimeout(function(){
            document.location.href = "{{=URL('default', 'index')}}"
        }, 5000);
    }
    else {
        currUser.fetch({
            success: function (currUser) {
                window.onload = populateCourses();
                $("#notloggedin").addClass("hidethis");
                $("#profile").removeClass("hidethis");
                $("#userInfo").removeClass("hidethis");
                $("#logout").removeClass("hidethis");

                var inactivityTime = function () {
                    var t;
                    window.onload = resetTimer;
                    document.onmousemove = resetTimer;
                    document.onkeypress = resetTimer;

                    function logout() {
                        alert("Your Session has Timed Out!");
                        Parse.User.logOut();
                        document.location.href = "{{=URL('default', 'index')}}";
                    }

                    function resetTimer() {
                        clearTimeout(t);
                        t = setTimeout(logout, 3600000);
                    }
                };

                inactivityTime();

                function populateCourses(){
                   var courses = currUser.get("webCourses").sort();
                   for(var i = 0; i < courses.length; i++){
                       var table = $("#coursetable");
                       table.append('<tr><td id="course">'+ courses[i]+'</td></tr>');
                   }
                }

                $("#inputbio").val("No Description");

                if(currUser.get("bio") || currUser.get("bio") !== "" || currUser.get("bio") != null){
                    $("#editbio")[0].innerHTML = currUser.get("bio");
                    $("#inputbio").val(currUser.get("bio"));
                }
                else{
                    $("#editbio")[0].innerHTML = "No Description";
                    $("#inputbio").val("No Description");
                }

                if(currUser.get("webCourses")){
                    var courseArray = currUser.get("webCourses");
                    $("#inputcourses").val(courseArray.toString().replace(/[, ]+/g, " ").trim());
                }

                $("#coursetable").click(function(e){
                    $("#coursetable").slideToggle();
                    $("#delete").slideToggle();
                    $("#add").slideToggle();
                });

                $("#add").click(function(e){
                    $("#delete").slideToggle();
                    $("#add").slideToggle();
                    $("#inputcourses").slideToggle();
                    $("#delete").remove();
                });

                $("#delete").click(function(e){
                    $("#add").slideToggle();
                    $("#delete").slideToggle();
                    $("#deletecourses").slideToggle();
                    $("#coursetable").slideToggle();
                    $("#add").remove();
                });

                $("#editbio").click(function(e){
                    $("#editbio").slideToggle();
                    $("#inputbio").slideToggle();
                });

                $("#logoutbtn").click(function (e) {
                    Parse.User.logOut();
                    document.location.href = "{{=URL('default', 'index')}}";
                });
                $("#editprofilepic").click(function (e) {
                    document.getElementById('fileBrowser').click();
                });
                function readURL(input) {
                    if (input.files && input.files[0]) {
                        var reader = new FileReader();

                        reader.onload = function (e) {
                            $('#editprofilepic').attr('src', e.target.result);
                        };

                        reader.readAsDataURL(input.files[0]);
                    }
                }

                $("#fileBrowser").change(function (e) {
                    readURL(this);
                });
                $("#saveprof").click(function (e) {
                    var courseArray = $("#inputcourses").val().toUpperCase().split(/\s+/);
                    var delcourseArray = $("#deletecourses").val().toUpperCase().split(/\s+/);
                    console.log(delcourseArray);
                    var fileUploadControl = $("#fileBrowser")[0];
                    if (fileUploadControl.files.length > 0) {
                        var file = fileUploadControl.files[0];
                        var name = "ProfilePic";

                        var parseFile = new Parse.File(name, file);
                        parseFile.save().then(function () {
                            currUser.set("bio", $("#inputbio").val());
                            currUser.set("ProfilePic", parseFile);
                            if($("#add").length){
                                for(var i = 0; i < courseArray.length; i++){
                                    currUser.addUnique("webCourses", courseArray[i]);
                                }
                            }
                            else if($("#delete").length){
                                for(var j = 0; j < delcourseArray.length; j++){
                                    currUser.remove("webCourses", delcourseArray[j]);
                                }
                            }

                            currUser.save(null, {
                                success: function (currUser) {
                                    document.location.href = "{{=URL('default', 'index')}}";
                                },
                                error: function (user, error) {
                                    // Show the error message somewhere and let the user try again.
                                    alert("Error: " + error.code + " " + error.message);
                                }
                            });
                        }, function (error) {
                            // The file either could not be read, or could not be saved to Parse.
                            alert("Error: " + error.code + " " + error.message);
                        });
                    }
                    else if (fileUploadControl.files.length <= 0) {
                        currUser.set("bio", $("#inputbio").val());
                        if($("#add").length){
                            for(var i = 0; i < courseArray.length; i++){
                                currUser.addUnique("webCourses", courseArray[i]);
                            }
                        }
                        else if($("#delete").length){
                            for(var j = 0; j < delcourseArray.length; j++){
                                currUser.remove("webCourses", delcourseArray[j]);
                            }
                        }
                        currUser.save(null, {
                            success: function (currUser) {
                                document.location.href = "{{=URL('default', 'index')}}";
                            },
                            error: function (user, error) {
                                // Show the error message somewhere and let the user try again.
                                alert("Error: " + error.code + " " + error.message);
                            }
                        });
                    }
                });

                var profilepic = currUser.get("ProfilePic");
                $("#editprofilepic")[0].src = profilepic.url();
                if (currUser.get("bio") == "") {
                    $("#editbio")[0].val = "No Description";
                }
                else {
                    $("#editbio")[0].val = currUser.get("bio");
                }
                if (currUser.get("isTutor")) {
                    $("#courselabel")[0].innerHTML = "Courses I Can Tutor";
                }
                else {
                    $("#courselabel")[0].innerHTML = "Courses I Want a Tutor For";
                }

                $("#cancel").click(function (e) {
                    document.location.href = "{{=URL('default', 'index')}}";
                });
            },
            error: function (error) {
                alert("Error: " + error.code + " " + error.message);
            }
        });
    }
</script>